format_version: 0.9.8
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib
app:
  envs: []
workflows:

  generate:
    title: Workflow for testing, PR check
    envs: []
    steps:
    - script:
        title: Set TMP_COLLECTION_ID
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            set -v
            envman add --key TMP_COLLECTION_ID --value "$(pwd)"
    - script:
        title: Remove previous version of this local spec from stepman
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            set -v
            stepman delete -c "${TMP_COLLECTION_ID}"
    - script:
        title: Generate
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            set -v
            tmp_dir="$(pwd)/_tmp"
            mkdir -p "${tmp_dir}"
            spec_path="${tmp_dir}/spec.json"
            stepman setup --local -c "${TMP_COLLECTION_ID}" --copy-spec-json="${spec_path}"
            envman add --key SPEC_JSON_PATH --value "${spec_path}"
    - script:
        title: tmp
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            echo "SPEC_JSON_PATH: ${SPEC_JSON_PATH}"
    - script:
        title: List of changed files
        dependencies:
        - manager: brew
          name: go
        inputs:
        - content: |-
            set -e
            localtest_param=""
            if [[ "${IS_LOCAL_TEST}" == "true" ]] ; then
              localtest_param="--localtest"
            fi
            go run ./_scripts/audit/audit_changed_steps.go --collectionid "${TMP_COLLECTION_ID}" ${localtest_param}

  deploy:
    title: Workflow for deployment
    before_run:
      - generate
    after_run: []
    envs:
      - AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
      - S3_UPLOAD_BUCKET: $S3_UPLOAD_BUCKET
    steps:
    - script:
        title: Generate
        dependencies:
          - manager: brew
            name: s3cmd
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            if [ ! -f "${SPEC_JSON_PATH}" ] ; then
              echo " [!] spec.json does not exist at path: ${SPEC_JSON_PATH}"
              exit 1
            fi
            set -v
            bash ./_scripts/deploy/deploy.sh
